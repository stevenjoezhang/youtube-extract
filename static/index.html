<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube解析</title>
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .loading {
            display: none;
        }
        .spinner-container {
            text-align: center;
            padding: 20px 0;
        }
        .error-message {
            margin-top: 20px;
        }
        .results-container {
            margin-top: 30px;
        }
        .table-container {
            overflow-x: auto;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-md navbar-light bg-light mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">YouTube解析</a>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <form id="extractForm">
                <div class="mb-3">
                    <label for="url" class="form-label">视频链接</label>
                    <input type="url" class="form-control" id="url" name="url" placeholder="输入YouTube视频链接" required>
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">解析</button>
            </form>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <!-- Loading Spinner -->
            <div class="loading spinner-container" id="loadingSpinner">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在解析视频信息...</p>
            </div>

            <!-- Error Message -->
            <div id="errorContainer"></div>

            <!-- Results Table -->
            <div id="resultsContainer" class="results-container"></div>
        </div>
    </div>
</div>

<script>
    const extractForm = document.getElementById('extractForm');
    const urlInput = document.getElementById('url');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorContainer = document.getElementById('errorContainer');
    const resultsContainer = document.getElementById('resultsContainer');
    const submitBtn = document.getElementById('submitBtn');

    function humanReadableSize(size, decimalPlaces = 2) {
        let units = ['B', 'KiB', 'MiB', 'GiB', 'TiB', 'PiB'];
        let unitIndex = 0;
        let sizeFloat = parseFloat(size);

        while (sizeFloat >= 1024.0 && unitIndex < units.length - 1) {
            sizeFloat /= 1024.0;
            unitIndex++;
        }

        return `${sizeFloat.toFixed(decimalPlaces)} ${units[unitIndex]}`;
    }

    function showError(message) {
        errorContainer.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        resultsContainer.innerHTML = '';
    }

    function showResults(data) {
        if (!data.formats || data.formats.length === 0) {
            showError('未找到可用的视频格式');
            return;
        }

        let tableHtml = `
            <div class="table-container">
                <table class="table table-striped table-hover align-middle caption-top">
                    <caption>${data.title}</caption>
                    <thead>
                        <tr>
                            <th>文件大小</th>
                            <th>分辨率</th>
                            <th>fps</th>
                            <th>拓展名</th>
                            <th>视频编码</th>
                            <th>音频编码</th>
                            <th>链接</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        data.formats.forEach(fmt => {
            const filesize = fmt.filesize ? humanReadableSize(fmt.filesize) : 'N/A';
            tableHtml += `
                <tr>
                    <td title="${fmt.filesize || 'N/A'}">${filesize}</td>
                    <td>${fmt.format_note}</td>
                    <td>${fmt.fps || 'N/A'}</td>
                    <td>${fmt.ext}</td>
                    <td>${fmt.vcodec}</td>
                    <td>${fmt.acodec}</td>
                    <td>
                        <button class="btn btn-success btn-sm copy-btn" data-url="${fmt.url}">复制</button>
                    </td>
                </tr>
            `;
        });

        tableHtml += `
                    </tbody>
                </table>
            </div>
        `;

        resultsContainer.innerHTML = tableHtml;
        errorContainer.innerHTML = '';

        // Add copy button event listeners
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const url = btn.dataset.url;
                navigator.clipboard.writeText(url).then(() => {
                    btn.textContent = '已复制';
                    setTimeout(() => {
                        btn.textContent = '复制';
                    }, 2000);
                }).catch(() => {
                    alert('复制失败！');
                });
            });
        });
    }

    extractForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const url = urlInput.value.trim();

        if (!url) {
            showError('请输入有效的URL');
            return;
        }

        loadingSpinner.style.display = 'block';
        errorContainer.innerHTML = '';
        resultsContainer.innerHTML = '';
        submitBtn.disabled = true;

        try {
            const response = await fetch(`/api/extract?url=${encodeURIComponent(url)}`);
            const data = await response.json();

            if (!response.ok) {
                showError(data.error || '解析失败');
            } else if (data.error) {
                showError(data.error);
            } else {
                showResults(data);
            }
        } catch (error) {
            showError(`网络错误: ${error.message}`);
        } finally {
            loadingSpinner.style.display = 'none';
            submitBtn.disabled = false;
        }
    });
</script>
</body>
</html>
